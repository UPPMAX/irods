#!/bin/sh -ex


# Manipulation, putting and getting of one dataset generated by poundtest.sh
# Usage: putget testid numputs fileset

testid=$1
ddir=$2

# SDL get rid of hardcoding
irodshome=/Users/slinz/iRODS
iDir=$irodshome/clients/icommands/bin
resourceset=`cat ResourcesToTest`
DATADIR=$irodshome/clients/concurrent-test/$ddir
FILES=`ls $DATADIR`
echo $DATADIR
TMP_DIR=TMP


# SDL we should have passed in the testid string
if [ "$1" = "" ]
then testid=`date "+%Y%m%d%H%M%S"`
else testid=$1
fi

echo "TESTID = $testid"

#  Initialize irods client environment, and get User information
#$iDir/iinit -v
#$iDir/iuserinfo -v
#$iDir/ilsresc -vl

$iDir/imkdir $testid
$iDir/icd $testid

for myresc in $resourceset ; do

	echo "Testing puts and gets in resource: " $myresc

	$iDir/imkdir Isub1
	$iDir/ils -lr
	$iDir/icd Isub1

	# put one at a time or put the whole directory?
	for file in $FILES ; do
		$iDir/iput -f -R $myresc $DATADIR/$file 
		# SDL we could add some meta key-value stuff here
	done

	$iDir/icd ..


	#  Display and Get all data files from irods space, store them in temp directory, 
	#  and compare them with another copy of same file to see if they match.
	for file in $FILES ; do
		$iDir/iget -f Isub1/$file $TMP_DIR/$file.$testid.tmp
		diff $DATADIR/$file $TMP_DIR/$file.$testid.tmp
		wc $DATADIR/$file $TMP_DIR/$file.$testid.tmp
		rm $TMP_DIR/$file.$testid.tmp
	done


	$iDir/imkdir Isub2

	#  Move all files from Iub1 to Iub2
	for file in $FILES ; do
		$iDir/imv Isub1/$file Isub2
	done

	$iDir/ils -lr

	#  Copy all data across different platforms, replicate, then get data to local 
	#  environment, and compare with local copies of same data.
	for store in $resourceset ; do
		for file in $FILES ; do
			$iDir/icp -f -R $store Isub2/$file Isub1/$file.$store
			#iDir/irepl -R $store Isub1/$file.$store SDL what is this
		done

		$iDir/iget -rf Isub1
		$iDir/iget -rf Isub2

		for file in $FILES ; do
			$iDir/iget Isub1/$file.$store $TMP_DIR/$file.$testid.tmp
			diff $DATADIR/$file $TMP_DIR/$file.$testid.tmp
			wc $DATADIR/$file $TMP_DIR/$file.$testid.tmp
			rm $TMP_DIR/$file.$testid.tmp
		done
	done

	$iDir/irm -r Isub1
	$iDir/irm -r Isub2
done

#  Remove test directory and end session
$iDir/icd 
$iDir/irm -r $testid
$iDir/irmtrash
$iDir/iexit

# SDL need proper return values
exit 0

