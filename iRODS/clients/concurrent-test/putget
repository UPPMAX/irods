#!/bin/sh -ex


# Manipulation, putting and getting of one dataset generated by poundtest.sh
# Usage: putget testid numputs fileset

if [ "$1" = "" ]
	then testid=`date "+%Y%m%d%H%M%S"`
else 
	testid=$1
fi

if [ "$2" = "" ]
	then ddir="butter"
else 
	ddir=$1
fi

echo "Running $testid $ddir"


# SDL get rid of hardcoding
irodshome=/Users/slinz/iRODS
iDir=$irodshome/clients/icommands/bin
resourceset=`cat ResourcesToTest`
DATADIR=$irodshome/clients/concurrent-test/$ddir
FILES=`ls $DATADIR`
TMP_DIR=TMP

#  Initialize irods client environment, and get User information
#$iDir/iinit -v
#$iDir/iuserinfo -v
#$iDir/ilsresc -vl

$iDir/imkdir $testid
$iDir/icd $testid

for myresc in $resourceset ; do

	echo "Testing puts and gets in resource: " $myresc

	$iDir/imkdir Isub1
	$iDir/icd Isub1

	# iput one file at a time or iput the whole directory?
	for file in $FILES ; do
		$iDir/iput -f -R $myresc $DATADIR/$file 
		$iDir/imeta add -d $DATADIR/$file $DATADIR "attributestring"
	done

	$iDir/icd ..

	# OK let's get back what we've just put in, do a 'diff' and a 'wc' for our first little test
	for file in $FILES ; do
		$iDir/iget -f Isub1/$file $TMP_DIR/$file.$testid.tmp
		diff $DATADIR/$file $TMP_DIR/$file.$testid.tmp
		wc $DATADIR/$file $TMP_DIR/$file.$testid.tmp
		# rm $TMP_DIR/$file.$testid.tmp
	done


	$iDir/imkdir Isub2

	#  Move all files from Iub1 to Iub2
	for file in $FILES ; do
		$iDir/imv Isub1/$file Isub2
	done

	#  Copy all data across different platforms, replicate, then get data to local 
	#  environment, and compare with local copies of same data.
	for store in $resourceset ; do
		for file in $FILES ; do
			$iDir/icp -f -R $store Isub2/$file Isub1/$file.$store
			#iDir/irepl -R $store Isub1/$file.$store SDL what is this
		done

		$iDir/iget -rf Isub1
		$iDir/iget -rf Isub2

		for file in $FILES ; do
			$iDir/iget Isub1/$file.$store $TMP_DIR/$file.$testid.tmp
			diff $DATADIR/$file $TMP_DIR/$file.$testid.tmp
			wc $DATADIR/$file $TMP_DIR/$file.$testid.tmp
			rm $TMP_DIR/$file.$testid.tmp
		done
	done

	$iDir/irm -r Isub1
	$iDir/irm -r Isub2
done

# Remove IRODS space test directories and end session
$iDir/icd 
$iDir/irm -r $testid
$iDir/irmtrash
$iDir/iexit

# Clean up locally
/bin/rm -rf TMP Isub1 Isub2

# SDL need proper return values
exit 0

