generateBagIt||msiCollCreate(*NEWBAGITROOT,1,*junk)##writeLine(stdout,"BagIt-Version: 0.96")##writeLine(stdout,"Tag-File-Character-Encoding: UTF-8")##msiDataObjCreate(*NEWBAGITROOT/bagit.txt,null,*FD)##msiDataObjWrite(*FD,stdout,*WLEN)##msiDataObjClose(*FD,*junk)##msiFreeBuffer(stdout)##msiCollRsync(*BAGITDATA,*NEWBAGITROOT/data,null,IRODS_TO_IRODS,*junk)##assign(*NEWBAGITDATA,*NEWBAGITROOT/data)##msiCollectionSpider(*NEWBAGITDATA,*Object,"msiDataObjChksum(*Object, forceChksum, *CHKSUM)##msiGetObjectPath(*Object,*FULLPATH,*junk)##msiStrlen(*NEWBAGITROOT,*ROOTLENGTH)##assign(*OFFSET,"*ROOTLENGTH + 1")##msiSubstr(*FULLPATH,*OFFSET,null,*RELATIVEPATH)##writeString(stdout, *RELATIVEPATH)##writeLine(stdout,"   *CHKSUM")",*Status)##msiDataObjCreate(*NEWBAGITROOT/manifest-md5.txt,null,*FD)##msiDataObjWrite(*FD,stdout,*WLEN)##msiDataObjClose(*FD,*junk)##msiFreeBuffer(stdout)##writeString(stdout,"bagit.txt    ")##msiDataObjChksum(*NEWBAGITROOT/bagit.txt,forceChksum,*CHKSUM)##writeLine(stdout,*CHKSUM)##writeString(stdout,"manifest-md5.txt    ")##msiDataObjChksum(*NEWBAGITROOT/manifest-md5.txt,forceChksum,*CHKSUM)##writeLine(stdout,*CHKSUM)##msiDataObjCreate(*NEWBAGITROOT/tagmanifest-md5.txt,null,*FD)##msiDataObjWrite(*FD,stdout,*WLEN)##msiDataObjClose(*FD,*junk)##msiFreeBuffer(stdout)##msiTarFileCreate(*NEWBAGITROOT.tar,*NEWBAGITROOT,null,*junk)##msiSplitPath(*NEWBAGITROOT.tar,*PATH,*TARFILENAME)##msiMakeQuery("DATA_SIZE","COLL_NAME like '*PATH%%' AND DATA_NAME = '*TARFILENAME'",*Query)##msiExecStrCondQuery(*Query,*E)##forEachExec(*E,msiGetValByKey(*E,DATA_SIZE,*FILESIZE),nop)##ifExec(*FILESIZE > 1048576,assign(*PRINTSIZE,"*FILESIZE / 1048576")##assign(*PRINTUNIT,"MB"),nop##nop,ifExec(*FILESIZE > 1024,assign(*PRINTSIZE,"*FILESIZE / 1024")##assign(*PRINTUNIT,"KB"),nop##nop,assign(*PRINTSIZE,*FILESIZE)##assign(*PRINTUNIT,"B"),nop##nop),nop)##writeLine(stdout,"")##writeLine(stdout,"Your BagIt bag has been created and tarred on the iRODS server:")##writeLine(stdout,"  *NEWBAGITROOT.tar - *PRINTSIZE *PRINTUNIT")##writeLine(stdout,"")##msiSplitPath(*NEWBAGITROOT.tar,*COLL,*TARFILE)##writeLine(stdout,"To copy it to your local computer, use:")##writeLine(stdout,"  iget -Pf *NEWBAGITROOT.tar *TARFILE")##writeLine(stdout,"")##msiWriteRodsLog("BagIt bag created: *NEWBAGITROOT <- *BAGITDATA",*junk)|nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop##nop
*BAGITDATA=$%*NEWBAGITROOT=$
ruleExecOut
